---
import Layout from '../layouts/Layout.astro';
import { DashboardSummary } from '../components/DashboardSummary';
import { ExpensePieChart } from '../components/ExpensePieChart';
import { RecentExpensesList } from '../components/RecentExpensesList';
import { NavBar } from '../components/NavBar';
import { createSupabaseServerInstance } from '../db/supabase.server';
import type { DashboardSummaryDTO, ExpenseListDTO } from '../types';

// Server-side data fetching
let dashboardData: DashboardSummaryDTO | undefined;
let expensesData: ExpenseListDTO | undefined;
let error: string | null = null;
let userEmail: string | undefined;

try {
  // Check authentication using SSR client
  const supabase = createSupabaseServerInstance({
    headers: Astro.request.headers,
    cookies: Astro.cookies
  });
  
  const { data: { session } } = await supabase.auth.getSession();
  
  if (!session) {
    return Astro.redirect('/login');
  }

  // Get user email for NavBar
  userEmail = session.user.email;

  // Fetch dashboard summary
  const summaryResponse = await fetch(`${Astro.url.origin}/api/dashboard/summary`, {
    headers: {
      'Cookie': Astro.request.headers.get('Cookie') || '',
    },
  });

  if (summaryResponse.ok) {
    dashboardData = await summaryResponse.json();
  }

  // Fetch recent expenses
  const expensesResponse = await fetch(`${Astro.url.origin}/api/expenses?limit=10&sort=expense_date.desc`, {
    headers: {
      'Cookie': Astro.request.headers.get('Cookie') || '',
    },
  });

  if (expensesResponse.ok) {
    expensesData = await expensesResponse.json();
  }
} catch (err) {
  console.error('Error fetching dashboard data:', err);
  error = 'Nie udało się załadować danych panelu';
}
---

<Layout title="Panel główny - Paragoniusz">
  <main class="container mx-auto px-4 py-8 pb-24 max-w-7xl">
    <div class="mb-8">
      <h1 class="text-3xl font-bold tracking-tight">Panel główny</h1>
      <p class="text-muted-foreground mt-2">
        Przegląd Twoich miesięcznych wydatków
      </p>
    </div>

    {error ? (
      <div class="rounded-lg border border-destructive bg-destructive/10 p-4 text-destructive" role="alert">
        <p class="font-semibold">Błąd ładowania panelu</p>
        <p class="text-sm mt-1">{error}</p>
      </div>
    ) : (
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {/* Dashboard Summary */}
        <div class="md:col-span-2 lg:col-span-1">
          <DashboardSummary client:load initialData={dashboardData} />
        </div>

        {/* Expense Pie Chart */}
        <div class="md:col-span-2 lg:col-span-2">
          <ExpensePieChart
            client:load
            categories={dashboardData?.categories || []}
            isLoading={!dashboardData}
          />
        </div>

        {/* Recent Expenses List */}
        <div class="md:col-span-2 lg:col-span-3">
          <RecentExpensesList client:load initialData={expensesData} />
        </div>
      </div>
    )}
  </main>
  <NavBar client:load userEmail={userEmail} />
</Layout>
